<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Game of Life</title>
    <style>
        .grid { display: grid; }
        .cell { width: 20px; height: 20px; border: 1px solid black; background-color: white; }
        .alive { background-color: green; }
        /* Added style for button spacing */
        button {
            margin-top: 10px; /* Adjust the value to increase or decrease the space */
        }
    </style>
</head>
<body>
<h1>Game of Life</h1>

<form id="gridForm">
    Rows: <input type="number" id="rows" min="1" required>
    Columns: <input type="number" id="cols" min="1" required>
    <button type="button" onclick="initializeGrid()">Initialize Grid</button>
</form>

<div id="gridContainer" class="grid"></div>

<form id="fileUploadForm" enctype="multipart/form-data">
    <input type="file" id="fileInput" accept=".json">
    <button type="button" onclick="uploadFile()">Upload JSON</button>
</form>

<script>
    function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        fetch('/game/upload', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                gridData = [];
                for (let i = 0; i < rows; i++) {
                    gridData.push(data.cells.slice(i * cols, (i + 1) * cols));
                }
                renderGrid();
            })
            .catch(error => console.error('Error:', error));
    }
</script>

<script>
    let rows, cols, gridData;
    let iterations = 0;  // Initialize iteration counter

    function initializeGrid() {
        rows = document.getElementById('rows').value;
        cols = document.getElementById('cols').value;
        iterations = 0;  // Reset the iteration counter
        gridData = Array.from({ length: rows }, () => Array.from({ length: cols }, () => ({ alive: false })));

        renderGrid();
    }

    function renderGrid() {
        const gridContainer = document.getElementById('gridContainer');
        gridContainer.style.gridTemplateRows = `repeat(${rows}, 20px)`;
        gridContainer.style.gridTemplateColumns = `repeat(${cols}, 20px)`;
        gridContainer.innerHTML = '';

        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.addEventListener('click', () => toggleCell(i, j));
                if (gridData[i][j].alive) {
                    cell.classList.add('alive');
                }
                gridContainer.appendChild(cell);
            }
        }
    }

    function toggleCell(row, col) {
        gridData[row][col].alive = !gridData[row][col].alive;
        renderGrid();
        iterations = 0;  // Reset the iteration counter
    }
</script>

<button onclick="getNextGeneration()">Next Generation</button>
<span id="iterationCount">Iterations: 0</span>

<script>
    function getNextGeneration() {
        // Prepare the current grid state to send to the backend
        const currentState = {
            iterations: iterations,
            rows: rows,
            cols: cols,
            cells: gridData.map((row, i) => row.map((cell, j) => ({ alive: cell.alive, row: i, col: j })).flat()).flat()
        };
        fetch('/game/next-generation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(currentState),
        })
            .then(response => response.json())
            .then(newState => {
                console.log(newState);
                // Update the gridData with the new state received from the backend
                gridData = [];
                for (let i = 0; i < rows; i++) {
                    gridData.push(newState.cells.slice(i * cols, (i + 1) * cols));
                }
                rows = newState.rows;
                cols = newState.cols;
                iterations = newState.iterations;
                renderGrid();  // Re-render the grid with the new state

                document.getElementById('iterationCount').innerText = `Iterations: ${iterations}`; // Update display
            })
            .catch(error => console.error('Error:', error));
    }
</script>

</body>
</html>
